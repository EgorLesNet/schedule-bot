import datetime
import pytz
import re
import os
import requests
import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    CallbackQueryHandler,
    ContextTypes,
)

# === –ù–ê–°–¢–†–û–ô–ö–ê –õ–û–ì–ì–ò–†–û–í–ê–ù–ò–Ø ===
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)

# === –ù–ê–°–¢–†–û–ô–ö–ò ===
BOT_TOKEN = os.getenv("BOT_TOKEN", "8016190941:AAFqoM5ysLgaGF6MtKh3KM9z-gKWLmW8kBs")
ICS_URL = "https://raw.githubusercontent.com/EgorLesNet/schedule-bot/main/GAUGN_1_kurs_2_potok_nodups.ics"
TIMEZONE = pytz.timezone("Europe/Moscow")

# === –ü–ê–†–°–ò–ù–ì ICS –ò–ó GITHUB ===
def load_events_from_github():
    events = []
    try:
        logging.info("–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∏–∑ GitHub...")
        response = requests.get(ICS_URL)
        response.raise_for_status()
        data = response.text
        
        for ev_block in data.split("BEGIN:VEVENT"):
            if "DTSTART" not in ev_block:
                continue
            try:
                start_str = re.search(r"DTSTART;TZID=Europe/Moscow:(\d{8}T\d{6})", ev_block).group(1)
                end_str = re.search(r"DTEND;TZID=Europe/Moscow:(\d{8}T\d{6})", ev_block).group(1)
                summary = re.search(r"SUMMARY:(.*)", ev_block).group(1).strip()
                desc_match = re.search(r"DESCRIPTION:(.*)", ev_block)
                desc = desc_match.group(1).strip() if desc_match else ""

                start = datetime.datetime.strptime(start_str, "%Y%m%dT%H%M%S")
                end = datetime.datetime.strptime(end_str, "%Y%m%dT%H%M%S")

                events.append({
                    "summary": summary,
                    "start": start,
                    "end": end,
                    "desc": desc
                })
            except Exception as e:
                logging.warning(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è: {e}")
                continue
                
        logging.info(f"–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ {len(events)} —Å–æ–±—ã—Ç–∏–π")
        return events
        
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞ —Å GitHub: {e}")
        return []

# === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
def get_week_range(date):
    start = date - datetime.timedelta(days=date.weekday())
    end = start + datetime.timedelta(days=6)
    return start, end

def format_event(ev):
    desc = ev["desc"]
    teacher, room = "", ""
    if "–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å" in desc:
        teacher = desc.split("–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å:")[1].split("\\n")[0].strip()
    if "–ê—É–¥–∏—Ç–æ—Ä–∏—è" in desc:
        room = desc.split("–ê—É–¥–∏—Ç–æ—Ä–∏—è:")[1].split("\\n")[0].strip()
    line = f"{ev['start'].strftime('%H:%M')}‚Äì{ev['end'].strftime('%H:%M')}  {ev['summary']}"
    if teacher or room:
        line += "\n"
    if teacher:
        line += f"üë®‚Äçüè´ {teacher}"
    if room:
        line += f" | üìç{room}"
    return line

def events_for_day(date):
    return [e for e in events if e["start"].date() == date]

def format_day(date, evs):
    if not evs:
        return f"üìÖ {date.strftime('%A, %d %B')} ‚Äî –∑–∞–Ω—è—Ç–∏–π –Ω–µ—Ç\n"
    text = f"üìÖ {date.strftime('%A, %d %B')}:\n"
    for ev in sorted(evs, key=lambda x: x["start"]):
        text += f"{format_event(ev)}\n\n"
    return text

# === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ===
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("üìÖ –°–µ–≥–æ–¥–Ω—è", callback_data="today")],
        [InlineKeyboardButton("üóì –≠—Ç–∞ –Ω–µ–¥–µ–ª—è", callback_data="this_week")],
        [InlineKeyboardButton("‚è≠ –°–ª–µ–¥—É—é—â–∞—è –Ω–µ–¥–µ–ª—è", callback_data="next_week")],
        [InlineKeyboardButton("üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ", callback_data="refresh")],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text(
        "–ü—Ä–∏–≤–µ—Ç! üëã\n–í—ã–±–µ—Ä–∏, —á—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å:",
        reply_markup=reply_markup
    )

async def handle_query(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    today = datetime.datetime.now(TIMEZONE).date()

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    if query.data == "refresh":
        global events
        events = load_events_from_github()
        await query.edit_message_text(
            text=f"‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ! –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(events)} —Å–æ–±—ã—Ç–∏–π",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("üìÖ –°–µ–≥–æ–¥–Ω—è", callback_data="today")],
                [InlineKeyboardButton("üóì –≠—Ç–∞ –Ω–µ–¥–µ–ª—è", callback_data="this_week")],
                [InlineKeyboardButton("‚è≠ –°–ª–µ–¥—É—é—â–∞—è –Ω–µ–¥–µ–ª—è", callback_data="next_week")],
            ])
        )
        return

    if query.data == "today":
        evs = events_for_day(today)
        text = format_day(today, evs)

    elif query.data == "this_week":
        start_date, _ = get_week_range(today)
        text = "üóì –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —ç—Ç—É –Ω–µ–¥–µ–ª—é:\n\n"
        for i in range(5):
            d = start_date + datetime.timedelta(days=i)
            text += format_day(d, events_for_day(d)) + "\n"

    elif query.data == "next_week":
        start_date, _ = get_week_range(today + datetime.timedelta(days=7))
        text = "‚è≠ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –Ω–µ–¥–µ–ª—é:\n\n"
        for i in range(5):
            d = start_date + datetime.timedelta(days=i)
            text += format_day(d, events_for_day(d)) + "\n"

    else:
        text = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞."

    keyboard = [
        [InlineKeyboardButton("üìÖ –°–µ–≥–æ–¥–Ω—è", callback_data="today")],
        [InlineKeyboardButton("üóì –≠—Ç–∞ –Ω–µ–¥–µ–ª—è", callback_data="this_week")],
        [InlineKeyboardButton("‚è≠ –°–ª–µ–¥—É—é—â–∞—è –Ω–µ–¥–µ–ª—è", callback_data="next_week")],
        [InlineKeyboardButton("üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ", callback_data="refresh")],
    ]
    await query.edit_message_text(
        text=text,
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

# === –ó–ê–ü–£–°–ö ===
def main():
    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
    global events
    events = load_events_from_github()
    
    if not events:
        logging.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–±—ã—Ç–∏—è. –ë–æ—Ç –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –ø—É—Å—Ç—ã–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º.")
    
    app = ApplicationBuilder().token(BOT_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(handle_query))
    
    logging.info("–ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    print("=" * 50)
    print("ü§ñ –ë–æ—Ç –¥–ª—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∑–∞–ø—É—â–µ–Ω!")
    print(f"üìÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å–æ–±—ã—Ç–∏–π: {len(events)}")
    print("‚èπÔ∏è  –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C")
    print("=" * 50)
    
    app.run_polling()

if __name__ == "__main__":
    main()
